<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="description" content="">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <!-- The above 4 meta tags *must* come first in the head; any other head content must come *after* these tags -->

    <!-- Title  -->
    <title>이쿠야 병원가자!</title>

    <!-- Favicon  -->
    <link rel="icon" href="img/core-img/favicon.ico">

    <!-- Style CSS -->
    <link rel="stylesheet" href="./css_file/style.css">
    <meta charset="utf-8"/>
    <!-- The core Firebase JS SDK is always required and must be listed first -->
    <script src="https://www.gstatic.com/firebasejs/7.15.0/firebase-app.js"></script>

    <!-- TODO: Add SDKs for Firebase products that you want to use
         https://firebase.google.com/docs/web/setup#available-libraries -->
    <script src="https://www.gstatic.com/firebasejs/7.15.0/firebase-analytics.js"></script>
    <script src="https://www.gstatic.com/firebasejs/3.3.0/firebase.js"></script>

    <script crc="http://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
    <link rel="stylesheet" href="resource/alertify.core.css"/>
    <link rel="stylesheet" href="resource/alertify.default.css" id="toggleCSS"/>
    <script src="resource/alertify.min.js"></script>
</head>

<body>
<!-- Preloader -->
<div id="preloader">
    <div class="medilife-load"></div>
</div>

<!-- ***** Header Area Start ***** -->
<header class="header-area">

    <!-- Main Header Area -->
    <div class="main-header-area" id="stickyHeader">
        <div class="container h-100">
            <div class="row h-100 align-items-center">
                <div class="col-12 h-100">
                    <div class="main-menu h-100">
                        <nav class="navbar h-100 navbar-expand-lg">
                            <!-- Logo Area  -->
                            <a class="navbar-brand" href="index.html"><img src="img/core-img/logo.png"
                                                                           alt="Logo"></a>

                            <button class="navbar-toggler" type="button" data-toggle="collapse"
                                    data-target="#medilifeMenu" aria-controls="medilifeMenu" aria-expanded="false"
                                    aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span>
                            </button>

                            <div class="collapse navbar-collapse" id="medilifeMenu">
                                <!-- Menu Area -->
                                <ul class="navbar-nav ml-auto">
                                    <li class="nav-item">
                                        <a class="nav-link" href="index.html">Home <span
                                                class="sr-only">(current)</span></a>
                                    </li>

                                    <li class="nav-item">
                                        <a class="nav-link" href="hospital_info.html">Hospital Information</a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" href="reservation.html">Reservation</a>
                                    </li>
                                    <li class="nav-item active">
                                        <a class="nav-link" href="reservation_info.html">Reservation Information</a>
                                    </li>
                                </ul>
                                <!-- Appointment Button -->
                                <div id="on_btn">
                                    <a id="log-memu" href="log_in.html" type="button"
                                       class="btn medilife-appoint-btn ml-30">Log-In/Sign-UP</a>
                                </div>
                            </div>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>
</header>
<!-- ***** Header Area End ***** -->


<article>
    <div class="container col-7">
        <div id="modify-area" class="align-items-center" style="padding-top: 180px; padding-bottom: 200px">
            <div class="container">
                <h1 style="padding-bottom: 30px">Reservation Details</h1>
                <form>
                    <fieldset disabled>
                        <div class="form-group">
                            <label for="Number">Reservation Number</label>
                            <input type="text" id="Number" class="form-control" style="color: #2e3133">
                        </div>
                        <div class="form-group">
                            <label for="Name">Hospital name</label>
                            <input type="text" class="form-control" id="Name" style="color: #2e3133">
                        </div>
                    </fieldset>

                    <label>Time</label>

                    <div class="row">
                        <div class="col">
                            <div class="form-group">
                                <input type="date" class="form-control" onchange="dateSelected(event);" name="date"
                                       id="date" style="color: #2e3133">
                            </div>
                        </div>
                        <div class="col">
                            <div class="form-group">
                                <select class="form-control" id="time" style="color: #2e3133">
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="Purpose">Purpose</label>
                        <select class="form-control text-dark" id="Purpose">
                            <option>미용</option>
                            <option>예방접종</option>
                            <option>정기검진</option>
                            <option>치료</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="Petname">Pet Name</label>
                        <input type="text" class="form-control" id="Petname" style="color: #2e3133">
                    </div>
                    <div class="form-group">
                        <label for="Petspecies">Pet Species</label>
                        <input type="text" class="form-control" id="Petspecies" style="color: #2e3133">
                    </div>
                    <div class="form-group" style="padding-bottom: 50px">
                        <label for="Message">Message</label>
                        <input type="text" class="form-control" id="Message" style="color: #2e3133">
                    </div>
                    <div class="row justify-content-center">
                        <button type="button" class="btn btn-primary" onclick="submitBtn()">Modify</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</article>


<!-- jQuery (Necessary for All JavaScript Plugins) -->
<script src="js/jquery/jquery-2.2.4.min.js"></script>
<!-- Popper js -->
<script src="js/popper.min.js"></script>
<!-- Bootstrap js -->
<script src="js/bootstrap.min.js"></script>
<!-- Plugins js -->
<!--<script src="js/plugins.js"></script>-->
<!-- Active js -->
<script src="js/active.js"></script>

<script src="config.js"></script>    <!-- hosting info -->

<script type="text/javascript">
    var database = firebase.database();
    var detailRef = database.ref('ReservationDetail/');
    var key = location.href.substr(
        location.href.lastIndexOf('=') + 1
    );
    var date;
    var area;
    var origin_time;

    $(document).ready(function () {
        detailRef.on("value", function (snapshot) {
            var number = 'No.' + snapshot.child(key).val().reservationNumber;
            var hospital = snapshot.child(key).val().hospital;
            var petName = snapshot.child(key).val().petName;
            var petSpecies = snapshot.child(key).val().petSpecies;
            var type = snapshot.child(key).val().purpose;
            var message = snapshot.child(key).val().message;
            date = snapshot.child(key).val().date;
            origin_time = snapshot.child(key).val().time;
            area = snapshot.child(key).val().area;

            document.getElementById('Number').value = number;
            document.getElementById('Name').value = hospital;
            document.getElementById('Petname').value = petName;
            document.getElementById('Petspecies').value = petSpecies;
            document.getElementById('Message').value = message;
            document.getElementById('date').value = date;
            // var event = new Event('change');
            // document.getElementById('date').dispatchEvent(event);

            //여기서 강제로 발생시키는 거에요
            $('#date').change();

            if (type === '미용') {
                $("#Purpose option:eq(0)").prop("selected", true);
            } else if (type === '예방접종') {
                $("#Purpose option:eq(1)").prop("selected", true);
            } else if (type === '정기검진') {
                $("#Purpose option:eq(2)").prop("selected", true);
            } else if (type === '치료') {
                $("#Purpose option:eq(3)").prop("selected", true);
            }
        });
    });

    //날짜 선택시 해당 병원, 해당 날짜에 비어있는 시간 time option에 추가.
    function dateSelected(e) {
        var target = document.getElementById("time");
        var hospital_v = document.getElementById('Name').value;
        var area_v = area;
        var close = 0;
        var open = 0;

        //병원 영업시간 받아서 변수에 저장하는 부분
        var ref = firebase.database().ref("Hospital_Info/");
        ref.on("value", function (snapshot) {
            snapshot.forEach(function (data) {
                //병원 이름과 병원이 있는 지역이 모두 같은 경우
                if (data.val().hospitalName === hospital_v) {
                    if (data.val().areaName === area_v) {
                        open = data.val().openTime;
                        close = data.val().closeTime;
                    }
                }
            });
        });

        setTimeout(function () {
            var openT = open.toString().split(":");
            var openH = Number(openT[0]);
            var openM = Number(openT[1]);
            if (openM > 0) {
                openH = openH + 1;
            }

            var closeT = close.toString().split(":");
            var closeH = Number(closeT[0]);
            var closeM = Number(closeT[1]);
            if (closeM > 0) {
                closeH = closeH + 1;
            }

            //예약정보들을 확인하며 예약이 있는 시간 찾고 select option에 넣는 부분
            target.options.length = 0;
            var opt = document.createElement("option");
            opt.value = origin_time;
            opt.innerHTML = origin_time;
            if (document.getElementById('date').value === date) {
                target.appendChild(opt);
            }

            var arr = [];
            var ref = firebase.database().ref("ReservationDetail/");

            //예약된 날짜와 같은 날짜의 예약 시간 받아 오는 코드
            ref.on("value", function (snapshot) {
                snapshot.forEach(function (data) {
                    if (data.val().hospital === hospital_v) {
                        if (data.val().area === area_v) {
                            if (data.val().date === e.target.value) {
                                arr.push(data.val().time);
                                console.log(arr);
                            }
                        }
                    }
                });
            });

            //예약된 시간을 제외한 시간을 출력
            available = []
            console.log(open);

            for (i = openH; i < closeH; i++) {
                var temp = String(i);
                temp = temp.concat("시");
                if (arr.indexOf(temp) === (-1)) {
                    var opt = document.createElement("option");
                    opt.value = temp;
                    opt.innerHTML = temp;
                    target.appendChild(opt);
                }
            }
            sortSelect(target);

            //예약 날짜와 선택한 날짜가 같은 경우 예약 시간 추가
            if (document.getElementById('date').value === date) {
                $("#time").val(origin_time).prop("selected", true);
            }
        }, 1000);
    }

    function sortSelect(selElem) {
        var tmpAry = [];
        for (var i = 0; i < selElem.options.length; i++) {
            tmpAry[i] = [];
            tmpAry[i][0] = selElem.options[i].text;
            tmpAry[i][1] = selElem.options[i].value;
        }
        tmpAry.sort();
        while (selElem.options.length > 0) {
            selElem.options[0] = null;
        }
        for (var i = 0; i < tmpAry.length; i++) {
            var op = new Option(tmpAry[i][0], tmpAry[i][1]);
            selElem.options[i] = op;
        }

    }

    //Modify 클릭시
    function submitBtn() {
        var purpose = document.getElementById('Purpose');
        var purpose_v = purpose.options[purpose.selectedIndex].innerHTML;
        var time = document.getElementById('time');
        var time_v = time.options[time.selectedIndex].value;

        detailRef.child(key).update({
            date: document.getElementById('date').value,
            time: time_v,
            reservationType: purpose_v,
            petName: document.getElementById('Petname').value,
            petSpecies: document.getElementById('Petspecies').value,
            message: document.getElementById('Message').value
        });

        alertify.alert('예약이 수정되었습니다.', function(){
            window.location.href = 'reservation_info.html';
        });

    }

</script>
<script src="account.js"></script>


</body>

</html>
