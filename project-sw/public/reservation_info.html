<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="description" content="">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <!-- The above 4 meta tags *must* come first in the head; any other head content must come *after* these tags -->

    <!-- Title  -->
    <title>이쿠야 병원가자!</title>

    <!-- Favicon  -->
    <link rel="icon" href="img/core-img/favicon.ico">

    <!-- Style CSS -->
    <link rel="stylesheet" href="./css_file/style.css">
    <meta charset="utf-8"/>
    <!-- The core Firebase JS SDK is always required and must be listed first -->
    <script src="https://www.gstatic.com/firebasejs/7.15.0/firebase-app.js"></script>

    <!-- TODO: Add SDKs for Firebase products that you want to use
         https://firebase.google.com/docs/web/setup#available-libraries -->
    <script src="https://www.gstatic.com/firebasejs/7.15.0/firebase-analytics.js"></script>
    <script src="https://www.gstatic.com/firebasejs/3.3.0/firebase.js"></script>
</head>

<body>
<!-- Preloader -->
<div id="preloader">
    <div class="medilife-load"></div>
</div>

<!-- ***** Header Area Start ***** -->
<header class="header-area">

    <!-- Main Header Area -->
    <div class="main-header-area" id="stickyHeader">
        <div class="container h-100">
            <div class="row h-100 align-items-center">
                <div class="col-12 h-100">
                    <div class="main-menu h-100">
                        <nav class="navbar h-100 navbar-expand-lg">
                            <!-- Logo Area  -->
                            <a class="navbar-brand" href="index.html"><img src="img/core-img/logo.png"
                                                                           alt="Logo"></a>

                            <button class="navbar-toggler" type="button" data-toggle="collapse"
                                    data-target="#medilifeMenu" aria-controls="medilifeMenu" aria-expanded="false"
                                    aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span>
                            </button>

                            <div class="collapse navbar-collapse" id="medilifeMenu">
                                <!-- Menu Area -->
                                <ul class="navbar-nav ml-auto">
                                    <li class="nav-item">
                                        <a class="nav-link" href="index.html">Home <span
                                                class="sr-only">(current)</span></a>
                                    </li>

                                    <li class="nav-item">
                                        <a class="nav-link" href="hospital_info.html">Hospital Information</a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" href="reservation.html">Reservation</a>
                                    </li>
                                    <li class="nav-item active">
                                        <a class="nav-link" href="reservation_info.html">Reservation Information</a>
                                    </li>
                                </ul>
                                <!-- Appointment Button -->
                                <div id="on_btn">
                                    <a id="log-memu" href="log_in.html" type="button"
                                       class="btn medilife-appoint-btn ml-30">Log-In/Sign-UP</a>
                                </div>
                            </div>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>
</header>
<!-- ***** Header Area End ***** -->

<!-- ***** Breadcumb Area Start ***** -->
<section class="breadcumb-area bg-img gradient-background-overlay" style="background-image: url(img/bg-img/bg1.jpg);">
    <div class="container h-100">
        <div class="row h-100 align-items-center">
            <div class="col-12">
                <div class="breadcumb-content">
                    <h3 class="breadcumb-title">Reservation Info.</h3>
                    <p>Please check your reservation list.</p>
                </div>
            </div>
        </div>
    </div>
</section>
<!-- ***** Breadcumb Area End ***** -->

<article>
    <div class="reservation-area">
        <div class="container">
            <div class="row align-items-center">
                <div id="card-area" class="col-12" style="padding-top: 10px; padding-bottom: 50px">

                </div>
                <h3 class="breadcumb-content" id="cancel_text"></h3>
                <div id="cancel-area" class="col-12" style="padding-top: 10px; padding-bottom: 200px">

                </div>
            </div>
        </div>
    </div>
</article>


<!-- jQuery (Necessary for All JavaScript Plugins) -->
<script src="js/jquery/jquery-2.2.4.min.js"></script>
<!-- Popper js -->
<script src="js/popper.min.js"></script>
<!-- Bootstrap js -->
<script src="js/bootstrap.min.js"></script>
<!-- Plugins js -->
<!--<script src="js/plugins.js"></script>-->
<!-- Active js -->
<script src="js/active.js"></script>

<script src="config.js"></script>    <!-- hosting info -->

<script src="account.js"></script>

<script type="text/javascript">
    var database = firebase.database();
    var ref = database.ref('ReservationDetail/');
    var userRef = database.ref('User/');
    var currentUser;
    var mode;
    var exist = false;

    var currentTime = new Date();

    $(document).ready(function () {

        //현재 유저의 이메일
        firebase.auth().onAuthStateChanged((user) => {
            if (user) {
                currentUser = user.email;
            }
        });

        // //Admin인지 Member인지 확인
        // userRef.on("value", function (snapshot) {
        //     snapshot.forEach(function (data) {
        //         data.forEach(function (ids) {
        //             if (currentUser === ids.val().email) {
        //                 mode = data.key
        //                 console.log("mode", mode);
        //             }
        //         });
        //     });
        // });

        //currentUser가 Member인 경우
        ref.once("value", function (snapshot) {
            snapshot.forEach(function (data) {
                if (data.val().clientId === currentUser) {
                    var key = data.key
                    var number = 'No.' + data.val().reservationNumber;
                    var hospital = data.val().hospital;
                    var purpose = data.val().purpose;
                    var time = data.val().date + ' ' + data.val().time;
                    var completion = data.val().completion;
                    var strArray = data.val().date.split('-');
                    var cancel = data.val().cancel;

                    //시간이 지난 예약인지 확인 (날짜, 시간)
                    if (isExpired(strArray, data.val().time.replace("시", ""))) {
                        ref.child(key).update({
                            completion: 'true'
                        });
                    }

                    //취소도 안되고 완료도 안된 예약
                    if (completion === 'false' && cancel !== 'true') {
                        $("#card-area").append("<div class=\"card m-3\">" +
                            "                       <div class=\"card-body\">\n" +
                            "                            <p class=\"card-text mb-0\">" + number + "</p>\n" +
                            "                            <h4 class=\"card-title\">" + hospital + "</h4>\n" +
                            "                            <p class=\"card-text mb-0\">" + purpose + "</p>\n" +
                            "                            <p class=\"card-text mb-0\">" + time + "</p>\n" +
                            "                            <div class=\"text-right\">\n" +
                            "                                <a href=\"#\" onclick=\"modify('" + key + "');\" class=\"card-link mr-3\">Modify</a>\n" +
                            "                                <a href=\"#\" onclick=\"cancel('" + key + "');\" class=\"card-link mr-3\">Cancel</a>\n" +
                            "                            </div>\n" +
                            "                        </div>" +
                            "</div>");
                    }

                    //취소나 완료된 경우
                    if (completion === 'true' || cancel === 'true') {
                        if (exist === false) {
                            document.getElementById("cancel_text").textContent = "Last reservations & Cancelled reservations"
                            exist = true;
                        }
                        $("#cancel-area").append("<div class=\"card m-3\">" +
                            "                       <div class=\"card-body\">\n" +
                            "                            <p class=\"card-text mb-0\">" + number + "</p>\n" +
                            "                            <h4 class=\"card-title\">" + hospital + "</h4>\n" +
                            "                            <p class=\"card-text mb-0\">" + purpose + "</p>\n" +
                            "                            <p class=\"card-text mb-0\">" + time + "</p>\n" +
                            "                            <div class=\"text-right\">\n" +
                            "                            </div>\n" +
                            "                        </div>" +
                            "</div>");
                    }
                }
            });
        });

        //currentUser가 Admin인 경우
        ref.once("value", function (snapshot) {
            snapshot.forEach(function (data) {
                if (data.val().hospitalAdminEmail === currentUser) {
                    var key = data.key
                    var number = 'No.' + data.val().reservationNumber;
                    var petName = data.val().petName;
                    var petAge = data.val().petAge;
                    var petGender = data.val().petGender;
                    var petSpecies = data.val().petSpecies;
                    var clientName = data.val().clientName;
                    var purpose = data.val().purpose;
                    var time = data.val().date + ' ' + data.val().time;
                    var completion = data.val().completion;
                    var phoneNum = data.val().phoneNum;
                    var message = data.val().message;
                    var strArray = data.val().date.split('-');
                    var cancel = data.val().cancel;

                    //시간이 지난 예약인지 확인 (날짜, 시간)
                    if (isExpired(strArray, data.val().time.replace("시", ""))) {
                        ref.child(key).update({
                            completion: 'true'
                        });
                    }

                    //취소도 안되고 완료도 안된 예약
                    if (completion === 'false' && cancel !== 'true') {
                        $("#card-area").append("<div class=\"card border-dark m-3\">\n" +
                            "                            <div class=\"card-header mb-0\">" +
                            "<div class=\"row\">" +
                            "<div class=\"col-sm-6\">" +
                            "                            <p class=\"card-text mb-0\">" + number + "</p>\n" +
                            "</div>\n" +
                            "<div class=\"col-sm-6\">" +
                            "                            <p class=\"card-text text-right mb-0\">" + time + "</p>\n" +
                            "</div>\n" +
                            "</div>\n" +
                            "</div>\n" +
                            "                            <div class=\"card-body text-success\">\n" +
                            "<div class=\"row\">" +
                            "<div class=\"col-sm-6\">" +
                            "                            <h5 class=\"card-title\">" + petName + "</h5>\n" +
                            "                            <p class=\"card-text mb-0\">" + "종: " + petSpecies + "</p>\n" +
                            "                            <p class=\"card-text mb-0\">" + "나이: " + petAge + "</p>\n" +
                            "                            <p class=\"card-text mb-0\">" + "성별: " + petGender + "</p>\n" +
                            "</div>" +
                            "<div class=\"col-sm-6\">" +
                            "                            <h5 class=\"card-title\">" + clientName + "</h5>\n" +
                            "                            <p class=\"card-text mb-0\">" + "연락처: " + phoneNum + "</p>\n" +
                            "                            <p class=\"card-text mb-0\">" + "방문목적: " + purpose + "</p>\n" +
                            "                            <p class=\"card-text mb-0\">" + "메시지: " + message + "</p>\n" +
                            "                        </div>" +
                            "</div>" +
                            "                        </div>" +
                            "                        </div>" +
                            "</div>"
                        )
                        ;
                    }

                    //취소나 완료된 경우
                    if (completion === 'true' || cancel === 'true') {
                        if (exist === false) {
                            document.getElementById("cancel_text").textContent = "Last reservations & Cancelled reservations"
                            exist = true;
                        }
                        $("#cancel-area").append("<div class=\"card border-dark m-3\">\n" +
                            "                            <div class=\"card-header mb-0\">" +
                            "<div class=\"row\">" +
                            "<div class=\"col-sm-6\">" +
                            "                            <p class=\"card-text mb-0\">" + number + "</p>\n" +
                            "</div>\n" +
                            "<div class=\"col-sm-6\">" +
                            "                            <p class=\"card-text text-right mb-0\">" + time + "</p>\n" +
                            "</div>\n" +
                            "</div>\n" +
                            "</div>\n" +
                            "                            <div class=\"card-body text-success\">\n" +
                            "<div class=\"row\">" +
                            "<div class=\"col-sm-6\">" +
                            "                            <h5 class=\"card-title\">" + petName + "</h5>\n" +
                            "                            <p class=\"card-text mb-0\">" + "Species: " + petSpecies + "</p>\n" +
                            "                            <p class=\"card-text mb-0\">" + "Age: " + petAge + "</p>\n" +
                            "                            <p class=\"card-text mb-0\">" + "Gender: " + petGender + "</p>\n" +
                            "</div>" +
                            "<div class=\"col-sm-6\">" +
                            "                            <h5 class=\"card-title\">" + clientName + "</h5>\n" +
                            "                            <p class=\"card-text mb-0\">" + "Phone: " + phoneNum + "</p>\n" +
                            "                            <p class=\"card-text mb-0\">" + "Purpose: " + purpose + "</p>\n" +
                            "                            <p class=\"card-text mb-0\">" + "Note: " + message + "</p>\n" +
                            "                        </div>" +
                            "</div>" +
                            "                        </div>" +
                            "                        </div>" +
                            "</div>");
                    }
                }
            });
        });
    });

    function cancel(param) {
        if (confirm('예약을 취소하시겠습니까?')) {
            ref.child(param).update({
                cancel: "true",
                time: ""
            })
            window.location.reload();
            return true;
        } else {
            return false;
        }
    }

    function modify(param) {
        window.location.href = "reservation_modify.html?param=" + param;
    }

    // //데이터베이스 변경 감지되었을 때
    // ref.on("child_changed", function(snapshot){
    //     window.location.reload();
    // });

    function isExpired(compareStr, compareTime) {
        var compareDate = new Date();

        compareDate.setFullYear(compareStr[0] * 1);
        compareDate.setMonth(compareStr[1] * 1 - 1);
        compareDate.setDate(compareStr[2] * 1);
        compareDate.setHours(compareTime * 1, 0, 0, 0);

        //현재 시각보다 예약시간이 지난 경우 true 리턴
        return currentTime >= compareDate;

    }

</script>

<script src="account.js"></script>

</body>

</html>
